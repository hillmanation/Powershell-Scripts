#############################
## Created By Jake Hillman ##
#############################

Import-Module ActiveDirectory

$users = Import-Csv -path "\\aetpdata\ourstuff\IA & SDS Collaboration Folder\Compass Account Management\Disable List\GUT-disable.csv"
##$users = Import-Csv -path "\\aetpdata\ourstuff\_Bryant\Script Output\GUT-Disable-Wrong-SSO.csv"
$descrDate = Get-Date -Format "MM/dd/yyyy"
$wrongsso = @()
$unknown = @()
$n = 0

ForEach ($user in $users) {

    $username = $user.SSO
    $name = $user.Name
    
    Try { Get-Aduser -identity $username | Out-Null } Catch { echo "Skipping $username, incorrect SamAccountName"; $wrongsso += $user; Continue }
    ##Try { Get-ADUser -filter { DisplayName -like "*$name*" }| Out-Null } Catch { echo "Skipping $username, incorrect SamAccountName"; $username = (Get-ADUser -filter { DisplayName -like "*$name*" }).SamAccountName; $unknown += $user; Continue }

    Disable-ADAccount -Identity $username

    ## Get the current Description create a new one adding the new Terminated on date
    $descr = (Get-ADUser -identity $username -Properties Description | Select-Object Description).Description
    $newdescr = "DO NOT ENABLE - General User Training Not Completed - disabled $descrdate - " + $descr

    ## The description field in AD is limited to 1024 characters, so for safety, check the string to ensure it won't go over
    If (($newdescr | Measure-Object -Character).Characters -ge 1023) { $newdescr = $newdescr.Substring(0,1023) } 

    ## Set the disabled account description to the new one, noting date disabled
    Set-ADUser -Identity $username -Description $newdescr

    ## Change User Training Property to False
    $attribute = $FALSE
    Set-ADUser -Identity $username -replace @{completedannualusertraining=$attribute}
    
    ## Log the user being disabled
    "$username disabled in AD..." | Out-File "\\aetpdata\ourstuff\_Hillman\Script Output\NoPrivUserTraining-Disabled-9162021.txt" -Append
    Get-ADUser -Identity $username -Properties Name,SamAccountName,Enabled,completedAnnualUserTraining,Description | Select-Object Name,SamAccountName,Enabled,completedAnnualUserTraining,Description | Export-CSV "\\aetpdata\ourstuff\_Hillman\Script Output\NoGUT-Users-Disabled-9142021.csv" -NoTypeInformation -Append
    $n++
}

$totalusers = ($users | Measure-Object).Count

"`r`n`n$n users out of $totalusers disabled" | Out-File "\\aetpdata\ourstuff\_Hillman\Script Output\NoPrivUserTraining-Disabled-9162021.txt" -Append

$unknown | Export-CSV "\\aetpdata\ourstuff\_Hillman\Script Output\PUT-Disable-Wrong-SSO.csv" -NoTypeInformation -Append